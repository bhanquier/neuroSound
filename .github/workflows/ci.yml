name: NeuroSound CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install LAME (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get update && sudo apt-get install -y lame
    
    - name: Install LAME (macOS)
      if: matrix.os == 'macos-latest'
      run: brew install lame
    
    - name: Install LAME (Windows)
      if: matrix.os == 'windows-latest'
      run: choco install lame
    
    - name: Test NeuroSound MP3 Extreme
      run: python neurosound_mp3_extreme.py
    
    - name: Test NeuroSound v3 Lossless
      run: python neurosound_v3.py
    
    - name: Verify outputs
      run: |
        ls -lh test_output.mp3
        ls -lh test_output.ns3

  energy-benchmark:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        sudo apt-get update && sudo apt-get install -y lame time
    
    - name: Energy Benchmark
      run: |
        echo "=== NeuroSound MP3 Extreme ==="
        /usr/bin/time -v python neurosound_mp3_extreme.py 2>&1 | grep -E "(Maximum resident|User time|System time)"
        
        echo ""
        echo "=== NeuroSound v3 Lossless ==="
        /usr/bin/time -v python neurosound_v3.py 2>&1 | grep -E "(Maximum resident|User time|System time)"
    
    - name: File Size Report
      run: |
        echo "=== Compression Ratios ==="
        test_size=$(stat -c%s test_input.wav)
        mp3_size=$(stat -c%s test_output.mp3)
        ns3_size=$(stat -c%s test_output.ns3)
        
        mp3_ratio=$(echo "scale=2; $test_size / $mp3_size" | bc)
        ns3_ratio=$(echo "scale=2; $test_size / $ns3_size" | bc)
        
        echo "Original: $test_size bytes"
        echo "MP3 Extreme: $mp3_size bytes (${mp3_ratio}x)"
        echo "v3 Lossless: $ns3_size bytes (${ns3_ratio}x)"
